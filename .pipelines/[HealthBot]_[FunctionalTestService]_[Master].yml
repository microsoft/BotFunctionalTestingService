pool:
  name: Azure-Pipelines-mshealthil-EO
  demands:
  - ImageOverride -equals ubuntu-1804-1es-compliant-agent-pool-image
  - npm
steps:
- powershell: |
   $BUILD_NUMBER = (Get-Childitem env:\BUILD_NUMBER).Value
   
   #package.json
   $packageJsonLocation = 'package.json'
   $packageJson = Get-Content $packageJsonLocation -raw | ConvertFrom-Json
   $packageJson.description = 'Microsoft Health Bot Functional Tests- build# ' + $BUILD_NUMBER
   $packageJson | ConvertTo-Json  | set-content $packageJsonLocation
  displayName: 'Replace tokens'
  env:
    BUILD_NUMBER: $(Build.BuildNumber)
#Task group has not been exported, task groups are not supported yet
- task: Npm@1
  displayName: 'npm install (server)'
  inputs:
    workingDir: '$(Build.SourcesDirectory)'
    verbose: false
- task: Npm@1
  displayName: 'npm update (server)'
  inputs:
    command: custom
    workingDir: '$(Build.SourcesDirectory)'
    verbose: false
    customCommand: update
- task: Npm@1
  displayName: 'npm run build  (server)'
  inputs:
    command: custom
    workingDir: '$(Build.SourcesDirectory)'
    verbose: false
    customCommand: 'run build'
- task: Npm@1
  displayName: 'npm install (client)'
  inputs:
    workingDir: 'n/a'
    verbose: false
  condition: and(succeeded(), ne(variables['client_folder'], 'n/a'))
- task: Npm@1
  displayName: 'npm update  (client)'
  inputs:
    command: custom
    workingDir: 'n/a'
    verbose: false
    customCommand: update
  condition: and(succeeded(), ne(variables['client_folder'], 'n/a'))
#Task group has not been exported, task groups are not supported yet
- task: DownloadPipelineArtifact@1
  displayName: 'Download Pipeline Artifact'
  inputs:
    buildType: specific
    project: '$(project)'
    pipeline: 74
    artifactName: 'health-bot-functional-tester-dockerfile-master'
- task: Docker@0
  displayName: 'Build an image'
  inputs:
    azureSubscription: 'hbs-arm-test'
    azureContainerRegistry: '{"loginServer":"hbscrtest.azurecr.io", "id" : "/subscriptions/$(hbsArmTest)/resourceGroups/hbs-rg-global-test/providers/Microsoft.ContainerRegistry/registries/hbscrtest"}'
    dockerFile: '$(Build.StagingDirectory)/Dockerfile'
    defaultContext: false
    context: '$(Build.SourcesDirectory)'
    imageName: 'functionaltestservice:$(Build.BuildNumber)'
    includeLatestTag: true
- task: ManifestGeneratorTask@0
  inputs:
    BuildDropPath: '$(Build.StagingDirectory)'
- task: PublishPipelineArtifact@1
  displayName: 'Publish SBOM Manifest'
  inputs:
    targetPath: '$(Build.StagingDirectory)/_manifest'
    artifact: 'SBOM_Manifest'
- task: Docker@0
  displayName: 'Push an image'
  inputs:
    azureSubscription: 'hbs-arm-test'
    azureContainerRegistry: '{"loginServer":"hbscrtest.azurecr.io", "id" : "/subscriptions/$(hbsArmTest)/resourceGroups/hbs-rg-global-test/providers/Microsoft.ContainerRegistry/registries/hbscrtest"}'
    action: 'Push an image'
    imageName: 'functionaltestservice:$(Build.BuildNumber)'
    includeLatestTag: true
#Task group has not been exported, task groups are not supported yet
- task: DownloadPipelineArtifact@1
  displayName: 'Download Pipeline Artifact - master'
  inputs:
    buildType: specific
    project: '$(project)'
    pipeline: 74
    artifactName: 'health-bot-functional-tester-dockerfile-master'
- task: DownloadPipelineArtifact@1
  displayName: 'Download Pipeline Artifact - development'
  inputs:
    buildType: specific
    project: '$(project)'
    pipeline: 72
    artifactName: 'health-bot-functional-tester-dockerfile-master'
  continueOnError: true
  condition: failed()
- task: Docker@0
  displayName: 'Build an image'
  inputs:
    azureSubscription: 'Health Agent-DevOps'
    azureContainerRegistry: '{"loginServer":"hbsdevops.azurecr.io", "id" : "/subscriptions/$(healthAgentDevops)/resourceGroups/HealthAgentDevOpsRG/providers/Microsoft.ContainerRegistry/registries/hbsdevops"}'
    dockerFile: '$(Build.StagingDirectory)/Dockerfile'
    defaultContext: false
    context: '$(Build.SourcesDirectory)'
    imageName: 'functionaltestservice:$(Build.BuildNumber)'
    includeLatestTag: true
- task: Docker@0
  displayName: 'Push an image'
  inputs:
    azureSubscription: 'Health Agent-DevOps'
    azureContainerRegistry: '{"loginServer":"hbsdevops.azurecr.io", "id" : "/subscriptions/$(healthAgentDevops)/resourceGroups/HealthAgentDevOpsRG/providers/Microsoft.ContainerRegistry/registries/hbsdevops"}'
    action: 'Push an image'
    imageName: 'functionaltestservice:$(Build.BuildNumber)'
    includeLatestTag: true
#Task group has not been exported, task groups are not supported yet
- task: DownloadPipelineArtifact@1
  displayName: 'Download Pipeline Artifact'
  inputs:
    buildType: specific
    project: '$(project)'
    pipeline: 74
    artifactName: 'health-bot-functional-tester-dockerfile-master'
- task: Docker@0
  displayName: 'Build an image'
  inputs:
    azureSubscription: 'hbs-arm-prod'
    azureContainerRegistry: '{"loginServer":"hbscrprod.azurecr.io", "id" : "/subscriptions/$(hbsArmProd)/resourceGroups/hbs-rg-global-prod/providers/Microsoft.ContainerRegistry/registries/hbscrprod"}'
    dockerFile: '$(Build.StagingDirectory)/Dockerfile'
    defaultContext: false
    context: '$(Build.SourcesDirectory)'
    imageName: 'functionaltestservice:$(Build.BuildNumber)'
    includeLatestTag: true
- task: Docker@0
  displayName: 'Push an image'
  inputs:
    azureSubscription: 'hbs-arm-prod'
    azureContainerRegistry: '{"loginServer":"hbscrprod.azurecr.io", "id" : "/subscriptions/$(hbsArmProd)/resourceGroups/hbs-rg-global-prod/providers/Microsoft.ContainerRegistry/registries/hbscrprod"}'
    action: 'Push an image'
    imageName: 'functionaltestservice:$(Build.BuildNumber)'
    includeLatestTag: true